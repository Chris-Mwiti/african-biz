datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

generator client {
  provider = "prisma-client-js"
}

model User {
  id                    String         @id @default(uuid())
  name                  String
  email                 String         @unique
  password              String
  googleId              String?        @unique
  facebookId            String?        @unique
  role                  Role           @default(GUEST)
  country_of_residence  String
  profile_image         String?
  subscription_status   String?
  created_at            DateTime       @default(now())
  updated_at            DateTime       @updatedAt
  status                UserStatus             @default(ACTIVE)
  listings              Listing[]
  events                Event[]
  blogs                 Blog[]
  subscriptions         Subscription[]
  favorites             Favorite[]
  reviews               Review[]
  analyticEvents        ListingAnalyticEvent[] // New inverse relation
}

model Listing {
  id                String        @id @default(uuid())
  title             String
  description       String
  address           String
  country           String
  city              String
  phone             String?
  email             String?
  website           String?
  social_links      Json?
  images            String[]
  category_id       String
  category          Category      @relation(fields: [category_id], references: [id])
  owner_id          String
  owner             User          @relation(fields: [owner_id], references: [id])
  status            ListingStatus @default(PENDING)
  is_premium        Boolean       @default(false)
  featured_priority Int?
  views_count       Int           @default(0)
  rating            Float?
  verified          Boolean       @default(false)
  created_at        DateTime      @default(now())
  updated_at        DateTime      @updatedAt
  views             ListingView[]
  favorites         Favorite[]
  reviews           Review[]
  events            Event[]
  blogs             Blog[]
  analyticEvents        ListingAnalyticEvent[] // New inverse relation
}

model Category {
  id       String    @id @default(uuid())
  name     String    @unique
  listings Listing[]
}

model Event {
  id              String        @id @default(uuid())
  title           String
  description     String
  start_datetime  DateTime
  end_datetime    DateTime
  location        String
  banner_image    String?
  listing_id      String
  listing         Listing       @relation(fields: [listing_id], references: [id])
  creator_id      String
  creator         User          @relation(fields: [creator_id], references: [id])
  approval_status ApprovalStatus @default(PENDING)

  @@index([start_datetime, end_datetime])
}

model Blog {
  id              String        @id @default(uuid())
  title           String
  content         String
  excerpt         String
  banner_image    String?
  tags            String[]
  listing_id      String
  listing         Listing       @relation(fields: [listing_id], references: [id])
  author_id       String
  author          User          @relation(fields: [author_id], references: [id])
  approval_status ApprovalStatus @default(PENDING)
  published_date  DateTime?

  @@index([author_id])
}

model Subscription {
  id                  String   @id @default(uuid())
  user_id             String
  user                User     @relation(fields: [user_id], references: [id])
  stripe_subscription_id String?  @unique
  status              String
  plan                String
  amount              Float
  started_at          DateTime
  ends_at             DateTime
  last_payment_at     DateTime?
}

model ListingView {
  id         String   @id @default(uuid())
  listing_id String
  listing    Listing  @relation(fields: [listing_id], references: [id])
  timestamp  DateTime @default(now())
}

model Favorite {
  id         String  @id @default(uuid())
  user_id    String
  user       User    @relation(fields: [user_id], references: [id])
  listing_id String
  listing    Listing @relation(fields: [listing_id], references: [id])

  @@unique([user_id, listing_id])
}

model Review {
  id         String   @id @default(uuid())
  user_id    String
  user       User     @relation(fields: [user_id], references: [id])
  listing_id String
  listing    Listing  @relation(fields: [listing_id], references: [id])
  rating     Int
  comment    String?
  created_at DateTime @default(now())

  @@unique([user_id, listing_id])
}

model ListingAnalyticEvent {
  id         String            @id @default(uuid())
  listing_id String
  listing    Listing           @relation(fields: [listing_id], references: [id], onDelete: Cascade)
  user_id    String?           // Optional, if user is logged in
  user       User?             @relation(fields: [user_id], references: [id])
  event_type AnalyticEventType
  details    Json?             // To store additional context (e.g., which link was clicked, user agent, IP address)
  timestamp  DateTime          @default(now())
}



enum Role {
  GUEST
  MEMBER
  PREMIUM
  ADMIN
}
enum ListingStatus {
  DRAFT
  PENDING
  ACTIVE
  REJECTED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
}

enum AnalyticEventType {
  VIEW      // When a listing detail page is loaded
  CLICK     // When an external link (website, social) is clicked
  CONTACT   // When a contact method (phone, email) is clicked/attempted
  CREATE_EVENT // When an event is created
  CREATE_BLOG // When a blog is created
}

enum UserStatus {
  ACTIVE
  INACTIVE
  BANNED
}


